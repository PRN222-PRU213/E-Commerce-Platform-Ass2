@* Notification bell icon with dropdown - include in navbar areas *@
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@if (User?.Identity?.IsAuthenticated ?? false)
{
    @Html.AntiForgeryToken()
<div class="nav-item dropdown" id="rt-bell-wrapper" style="position:relative;display:inline-block;">
    <a href="#" class="btn border position-relative" id="rt-bell-btn" role="button"
       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <i class="fas fa-bell text-primary"></i>
        <span class="badge badge-danger position-absolute" id="rt-bell-badge"
              style="top:-5px;right:-5px;font-size:10px;min-width:18px;height:18px;line-height:18px;border-radius:50%;padding:0 4px;display:none;">
            0
        </span>
    </a>
    <div class="dropdown-menu dropdown-menu-right shadow-sm" id="rt-bell-dropdown"
         style="width:340px;max-height:400px;overflow-y:auto;padding:0;border-radius:8px;">
        <div class="px-3 py-2 border-bottom d-flex justify-content-between align-items-center"
             style="background:#f8f9fa;">
            <strong style="font-size:14px;">Thông báo</strong>
            <a href="#" id="rt-bell-clear" class="text-muted" style="font-size:12px;text-decoration:none;">
                Xóa tất cả
            </a>
        </div>
        <div id="rt-bell-list">
            <div class="text-center text-muted py-4" id="rt-bell-empty" style="font-size:13px;">
                <i class="fas fa-bell-slash mb-2" style="font-size:24px;opacity:.4;display:block;"></i>
                Chưa có thông báo mới
            </div>
        </div>
    </div>
</div>

<style>
    #rt-bell-wrapper .dropdown-menu { border: 1px solid rgba(0,0,0,.1); }
    .rt-bell-item { display: flex; align-items: flex-start; padding: 10px 14px; border-bottom: 1px solid #f0f0f0;
        text-decoration: none; color: #333; transition: background .15s; cursor: pointer; }
    .rt-bell-item:hover { background: #f8f9fa; text-decoration: none; color: #333; }
    .rt-bell-item .rt-bell-icon { width: 32px; height: 32px; border-radius: 50%; display: flex;
        align-items: center; justify-content: center; flex-shrink: 0; margin-right: 10px; font-size: 14px; }
    .rt-bell-icon-success { background: #d4edda; color: #28a745; }
    .rt-bell-icon-info    { background: #d1ecf1; color: #17a2b8; }
    .rt-bell-icon-warning { background: #fff3cd; color: #856404; }
    .rt-bell-icon-error   { background: #f8d7da; color: #dc3545; }
    .rt-bell-msg { font-size: 13px; line-height: 1.35; flex: 1; }
    .rt-bell-time { font-size: 11px; color: #999; margin-top: 2px; }
    #rt-bell-badge { animation: rt-bell-pulse .6s ease; }
    @@keyframes rt-bell-pulse {
        0%,100% { transform: scale(1); }
        50% { transform: scale(1.3); }
    }
</style>

<script>
(function () {
    var list = document.getElementById('rt-bell-list');
    var badge = document.getElementById('rt-bell-badge');
    var empty = document.getElementById('rt-bell-empty');
    var clearBtn = document.getElementById('rt-bell-clear');
    var bellBtn = document.getElementById('rt-bell-btn');
    var count = 0;
    var maxItems = 20;

    var iconMap = {
        success: { cls: 'rt-bell-icon-success', icon: 'fas fa-check-circle' },
        info:    { cls: 'rt-bell-icon-info',    icon: 'fas fa-info-circle' },
        warning: { cls: 'rt-bell-icon-warning', icon: 'fas fa-exclamation-triangle' },
        error:   { cls: 'rt-bell-icon-error',   icon: 'fas fa-times-circle' }
    };

    function addItem(type, message, link, timeAgo, isRead) {
        if (empty) empty.style.display = 'none';

        var info = iconMap[type] || iconMap.info;
        var el = document.createElement(link ? 'a' : 'div');
        el.className = 'rt-bell-item' + (isRead ? '' : ' font-weight-bold');
        if (!isRead) el.style.background = '#edf2fa';
        if (link) el.href = link;

        el.innerHTML =
             '<div class="rt-bell-icon ' + info.cls + '"><i class="' + info.icon + '"></i></div>' +
            '<div class="rt-bell-msg">' + message +
            '<div class="rt-bell-time">' + (timeAgo || 'Vừa xong') + '</div></div>';

        if (list.firstChild && list.firstChild !== empty) {
            list.insertBefore(el, list.firstChild);
        } else {
            list.appendChild(el);
        }
    }

    function loadNotifications() {
        fetch('/Notifications?handler=Json&count=' + maxItems)
            .then(res => res.json())
            .then(data => {
                // Clear current list (except empty placeholder which is managed by addItem)
                while(list.firstChild) list.removeChild(list.firstChild);
                // Re-add empty (hidden by default)
                if(empty) { list.appendChild(empty); empty.style.display = 'block'; }

                if (data.notifications && data.notifications.length > 0) {
                    // Reverse to add correct order since addItem calls insertBefore
                    [...data.notifications].reverse().forEach(n => {
                        addItem(n.type, n.message, n.link, n.timeAgo, n.isRead);
                    });
                }

                if (data.unreadCount > 0) {
                    count = data.unreadCount;
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(err => console.error('Failed to load notifications', err));
    }

    // Load on start
    loadNotifications();

    // SignalR listener (Real-time)
    document.addEventListener('rt:notification', function (e) {
        var d = e.detail;
        addItem(d.type, d.message, d.link, 'Vừa xong', false);
        count++;
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'inline-block';
    });

    document.addEventListener('rt:product-changed', function (e) {
        var d = e.detail;
        var labels = { created:'Sản phẩm mới', updated:'Cập nhật SP', statusChanged:'Trạng thái SP', deleted:'Xóa SP' };
        var msg = (labels[d.changeType] || 'SP thay đổi') + ': <strong>' + (d.name || '') + '</strong>';
        addItem('info', msg, null, 'Vừa xong', false);
    });

    // Helper to get CSRF token
    function getCsrfToken() {
        return document.querySelector('input[name="__RequestVerificationToken"]')?.value;
    }

    // Mark all read on click clear
    if (clearBtn) {
        clearBtn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            fetch('/Notifications?handler=MarkAllRead', { 
                method: 'POST',
                headers: {
                    'RequestVerificationToken': getCsrfToken()
                }
            })
            .then(() => {
                    loadNotifications();
            });
        });
    }
})();
</script>
}
